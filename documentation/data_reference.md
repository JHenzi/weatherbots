# Data Reference

This document describes the purpose and schema of the key data files used and generated by the bot in the `Data/` directory.

## Core Configuration & Metadata

### `weights.json`
- **Purpose**: Stores the learned weights for each weather source per city.
- **Used by**: `run_daily.py` (post-processing).
- **Updated by**: `calibrate_sources.py` (nightly).
- **Schema**:
  ```json
  {
    "city_code": {
      "as_of": "YYYY-MM-DD",
      "window_days": 14,
      "weights": {
        "source_name": 0.25,
        ...
      }
    }
  }
  ```

### `city_metadata.json`
- **Purpose**: Stores city-specific historical constants like $MAE_{\text{historical}}$.
- **Used by**: `kalshi_trader.py` (calculating $\sigma$).
- **Updated by**: `update_city_metadata.py`.

## Operational Logs

### `observations_history.csv`
- **Purpose**: Per-station observation snapshots throughout the day for backtesting when we "learn" the peak temperature. Written by the dashboard API observation loop.
- **Key Columns**: `timestamp`, `city`, `stid`, `temp`, `observed_high_today`, `projected_high`, `trend_10m`, `trend_30m`, `trend_1h`, `acceleration`, `time_temp_will_max` (ISO time when temp will max, from solar model).

### `predictions_history.csv`
- **Purpose**: A running log of every prediction made by the bot.
- **Key Columns**: `date`, `city`, `tmax_predicted`, `tmax_lstm`, `tmax_forecast`, `spread_f`, `confidence_score`, `sources_used`.

### `trades_history.csv`
- **Purpose**: Tracks every trade intent and actual execution. Used for idempotency.
- **Key Columns**: `run_ts`, `env`, `trade_date`, `city`, `market_ticker`, `side`, `count`, `yes_price`, `send_orders`.

### `decisions_history.csv`
- **Purpose**: Audit log of why the bot decided to trade or skip.
- **Key Columns**: `run_ts`, `city`, `decision` (trade/skip), `reason` (e.g., `spread > 3.0`, `confidence < 0.5`).

### `eval_history.csv`
- **Purpose**: The most detailed log, combining predictions, market state (ask, depth), and eventual settlement outcome.
- **Key Columns**: Includes all from `predictions_history` plus `yes_ask`, `ask_qty`, `model_prob_yes`, `ev_cents`.

## Performance Tracking

### `source_performance.csv`
- **Purpose**: Tracks the error of every individual weather source for every day.
- **Key Columns**: `date`, `city`, `source_name`, `predicted_tmax`, `actual_tmax`, `absolute_error`.

### `daily_metrics.csv`
- **Purpose**: Aggregated daily performance metrics used for budget allocation.
- **Key Columns**: `trade_date`, `city`, `metric_type` (mae_f, bucket_hit_rate), `value`.

## Model Artifacts

## Database (Postgres)

When `ENABLE_PG_WRITE` is set, the same data is mirrored into Postgres. Key tables include `predictions`, `trades`, `decisions`, `eval_events`, `intraday_snapshots`, `observations`, `eval_metrics`, `source_performance`, `weights_history`. The `observations` table mirrors `observations_history.csv` (observed_at, city_id, stid, temp, observed_high_today, projected_high, trend_*, acceleration, time_temp_will_max).

## Model Artifacts

### `model_<city>.keras`
- **Purpose**: The trained LSTM model for each city.

### `prediction_merged_df_<city>.pkl`
- **Purpose**: Rolling window of cleaned weather features used as input for the LSTM model.
